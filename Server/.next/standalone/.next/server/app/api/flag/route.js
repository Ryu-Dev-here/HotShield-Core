"use strict";(()=>{var e={};e.id=389,e.ids=[389],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4770:e=>{e.exports=require("crypto")},5545:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>$,patchFetch:()=>H,requestAsyncStorage:()=>P,routeModule:()=>M,serverHooks:()=>L,staticGenerationAsyncStorage:()=>B});var n={};r.r(n),r.d(n,{POST:()=>F});var i=r(9303),a=r(8716),o=r(670),s=r(7070),l=r(8484),c=r(7048),u=r(2631),d=r(9713),p=r(1585);let f=p.Ry({targetUuid:p.Z_().uuid().optional(),targetUsername:p.Z_().min(1).max(16).optional(),category:p.Km(["TRADE_SCAM","FAKE_MIDDLEMAN","ACCOUNT_SCAM","COIN_SCAM","OTHER"]),description:p.Z_().min(1).max(5e3),proofLinks:p.IX(p.Z_().url()).max(10),reporterFingerprint:p.Z_().min(1),timestamp:p.Z_()});var g=r(4770),h=r.n(g);let m=process.env.HMAC_SECRET||"";m||console.warn("HMAC_SECRET not set, signature validation will fail");let w=new Map,y={perFingerprint:{count:10,windowMs:36e5},perIP:{count:50,windowMs:36e5}};function I(e,t){let r=Date.now(),n=w.get(e);return!n||r>n.resetTime?(w.set(e,{count:1,resetTime:r+t.windowMs}),!0):!(n.count>=t.count)&&(n.count++,!0)}let E=(process.env.ALLOWED_PROOF_DOMAINS||"").split(",").map(e=>e.trim().toLowerCase()).filter(e=>e.length>0),A=["trustmebro.com","fake-proof.com","localhost","127.0.0.1"];async function R(e){try{var t;let r=await fetch(`https://api.mojang.com/users/profiles/minecraft/${encodeURIComponent(e)}`);if(!r.ok)return null;let n=await r.json();return n.id?(t=n.id).includes("-")?t:`${t.slice(0,8)}-${t.slice(8,12)}-${t.slice(12,16)}-${t.slice(16,20)}-${t.slice(20)}`:null}catch(e){return null}}async function S(e,t,r,n,i){let a;if(!function(e,t=300){let r=parseInt(e,10);if(isNaN(r))return!1;let n=Math.floor(Date.now()/1e3)-r;return n>=0&&n<=t}(r))return{valid:!1,error:"Invalid or expired timestamp"};if(!function(e,t,r){if(!m)return!1;let n=function(e,t){let r=`${e}:${t}`;return h().createHmac("sha256",m).update(r).digest("hex")}(e,t);return h().timingSafeEqual(Buffer.from(r),Buffer.from(n))}(e,r,t))return{valid:!1,error:"Invalid signature"};let o=function(e,t){let r=`ip:${t}`;return I(`fingerprint:${e}`,y.perFingerprint)?I(r,y.perIP)?{allowed:!0}:{allowed:!1,reason:"IP rate limit exceeded"}:{allowed:!1,reason:"Fingerprint rate limit exceeded"}}(n,i);if(!o.allowed)return{valid:!1,error:o.reason};try{a=f.parse(JSON.parse(e))}catch(e){return{valid:!1,error:"Invalid request format"}}let s=null;if(a.targetUuid){var l;if(l=a.targetUuid,!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(l))return{valid:!1,error:"Invalid UUID format"};s=a.targetUuid}else if(!a.targetUsername)return{valid:!1,error:"Either targetUuid or targetUsername required"};else if(!(s=await R(a.targetUsername)))return{valid:!1,error:"Could not resolve UUID from username"};let c=function(e){let t=[],r=[];for(let n of e)(function(e){try{let t=new URL(e).hostname.toLowerCase();if(A.some(e=>t.includes(e)))return!1;if(0===E.length)return!0;return E.some(e=>t.includes(e)||t.endsWith(`.${e}`))}catch{return!1}})(n)?t.push(n):r.push(n);return{valid:t,invalid:r}}(a.proofLinks);return 0===c.valid.length&&a.proofLinks.length>0?{valid:!1,error:"No valid proof links provided"}:{valid:!0,targetUuid:s,normalizedDescription:a.description,validProofLinks:c.valid}}function O(e,t){var r;return r=t?`${e}:${t}`:e,h().createHash("sha256").update(r).digest("hex")}async function v(e,t,r,n){let i=[],a=await (0,l.N)(),o=new c.w(a),s=new u.F(a),d=await o.findByReporterFingerprint(e,10),p=await s.findByFingerprint(e);for(let e of(d.length>=5&&d.filter(e=>new Date(e.timestamp).getTime()>new Date(r).getTime()-6e4).length>=5&&i.push({type:"MASS_FLAG_BURST",severity:"high",detected:!0}),t))if((await o.findByProofHash(e)).length>3){i.push({type:"PROOF_REUSE_SPAM",severity:"medium",detected:!0});break}return p?.abuseFlags.length&&p.abuseFlags.length>2&&i.push({type:"REPEAT_OFFENDER",severity:"high",detected:!0}),i}async function D(e,t){let r=await (0,l.N)(),n=new u.F(r),i=t.filter(e=>"high"===e.severity);if(i.length>0){for(let t of i)await n.addAbuseFlag(e,t.type);await n.setShadowBanned(e,!0),await n.adjustTrustScore(e,-20)}else for(let r of t)await n.addAbuseFlag(e,r.type)}var U=r(5634);let C={randomUUID:h().randomUUID},x=new Uint8Array(256),N=x.length,T=[];for(let e=0;e<256;++e)T.push((e+256).toString(16).slice(1));let _=function(e,t,r){if(C.randomUUID&&!t&&!e)return C.randomUUID();let n=(e=e||{}).random||(e.rng||function(){return N>x.length-16&&(h().randomFillSync(x),N=0),x.slice(N,N+=16)})();if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,t){r=r||0;for(let e=0;e<16;++e)t[r+e]=n[e];return t}return function(e,t=0){return T[e[t+0]]+T[e[t+1]]+T[e[t+2]]+T[e[t+3]]+"-"+T[e[t+4]]+T[e[t+5]]+"-"+T[e[t+6]]+T[e[t+7]]+"-"+T[e[t+8]]+T[e[t+9]]+"-"+T[e[t+10]]+T[e[t+11]]+T[e[t+12]]+T[e[t+13]]+T[e[t+14]]+T[e[t+15]]}(n)};async function F(e){try{let t;let r=e.headers.get("X-HotShield-Signature")||"",n=e.headers.get("X-HotShield-Timestamp")||"",i=await e.text(),a=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||"unknown";try{t=JSON.parse(i)}catch{return s.NextResponse.json({error:"Invalid JSON"},{status:400})}let o=t.reporterFingerprint||"";if(!o)return s.NextResponse.json({error:"Missing reporterFingerprint"},{status:400});let p=await S(i,r,n,o,a);if(!p.valid)return s.NextResponse.json({error:p.error},{status:400});let f=await (0,l.N)(),g=new c.w(f),h=new u.F(f),m=new d.J(f),w=await v(o,(p.validProofLinks||[]).map(e=>O(e)),n,a);if(w.some(e=>e.detected)&&await D(o,w),(await h.findOrCreate(o)).shadowBanned)return s.NextResponse.json({error:"Rate limit exceeded"},{status:429});let y=_(),I=(p.normalizedDescription||"").normalize("NFKC").replace(/[\u200B-\u200D\uFEFF]/g,"").replace(/\s+/g," ").trim(),E=(p.validProofLinks||[]).map(e=>O(e)),A={reportId:y,targetUuid:p.targetUuid,targetUsername:t.targetUsername||"Unknown",reporterFingerprint:o,category:t.category,description:I,proofLinks:p.validProofLinks||[],proofHashes:E,timestamp:new Date().toISOString(),status:U.R.QUEUED,metadata:{ip:a,userAgent:e.headers.get("user-agent")||void 0}};return await g.create(A),await h.incrementReportCount(o),await m.log({action:d.V.REPORT_CREATED,actor:o,target:p.targetUuid,timestamp:new Date().toISOString(),ipAddress:a,metadata:{reportId:y,category:t.category}}),s.NextResponse.json({reportId:y,status:"queued"},{status:201})}catch(e){return console.error("Error processing flag request:",e),s.NextResponse.json({error:"Internal server error"},{status:500})}}let M=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/flag/route",pathname:"/api/flag",filename:"route",bundlePath:"app/api/flag/route"},resolvedPagePath:"C:\\Users\\Admin\\Documents\\Project\\HotShield\\Server\\src\\app\\api\\flag\\route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:P,staticGenerationAsyncStorage:B,serverHooks:L}=M,$="/api/flag/route";function H(){return(0,o.patchFetch)({serverHooks:L,staticGenerationAsyncStorage:B})}},9713:(e,t,r)=>{var n;r.d(t,{J:()=>i,V:()=>n}),function(e){e.REPORT_CREATED="REPORT_CREATED",e.VERDICT_CHANGED="VERDICT_CHANGED",e.REPORTER_BANNED="REPORTER_BANNED",e.CASE_VIEWED="CASE_VIEWED",e.ADMIN_LOGIN="ADMIN_LOGIN",e.ADMIN_LOGOUT="ADMIN_LOGOUT",e.STATE_TRANSITION="STATE_TRANSITION"}(n||(n={}));class i{constructor(e){this.collection=e.collection("audit_logs"),this.ensureIndexes()}async ensureIndexes(){await this.collection.createIndex({timestamp:-1}),await this.collection.createIndex({actor:1}),await this.collection.createIndex({target:1}),await this.collection.createIndex({action:1})}async log(e){await this.collection.insertOne(e)}async findByTarget(e,t=100){return this.collection.find({target:e}).sort({timestamp:-1}).limit(t).toArray()}async findByActor(e,t=100){return this.collection.find({actor:e}).sort({timestamp:-1}).limit(t).toArray()}async findAll(e=1e3){return this.collection.find({}).sort({timestamp:-1}).limit(e).toArray()}}},7048:(e,t,r)=>{r.d(t,{w:()=>i});var n=r(5634);class i{constructor(e){this.collection=e.collection("reports"),this.ensureIndexes()}async ensureIndexes(){await this.collection.createIndex({reportId:1},{unique:!0}),await this.collection.createIndex({targetUuid:1}),await this.collection.createIndex({reporterFingerprint:1}),await this.collection.createIndex({status:1}),await this.collection.createIndex({timestamp:-1}),await this.collection.createIndex({proofHashes:1})}async create(e){await this.collection.insertOne(e)}async findByReportId(e){return this.collection.findOne({reportId:e})}async findByTargetUuid(e){return this.collection.find({targetUuid:e}).toArray()}async findQueued(){return this.collection.find({status:n.R.QUEUED}).toArray()}async updateStatus(e,t,r){let n={status:t};void 0!==r&&(n.weight=r),await this.collection.updateOne({reportId:e},{$set:n})}async findByProofHash(e){return this.collection.find({proofHashes:e}).toArray()}async findByReporterFingerprint(e,t=100){return this.collection.find({reporterFingerprint:e}).sort({timestamp:-1}).limit(t).toArray()}}},2631:(e,t,r)=>{r.d(t,{F:()=>n});class n{constructor(e){this.collection=e.collection("reporters"),this.ensureIndexes()}async ensureIndexes(){await this.collection.createIndex({fingerprint:1},{unique:!0}),await this.collection.createIndex({trustScore:-1}),await this.collection.createIndex({shadowBanned:1})}async findOrCreate(e){let t=await this.collection.findOne({fingerprint:e});if(t)return t;let r={fingerprint:e,trustScore:50,reportCount:0,verifiedCount:0,clearedCount:0,abuseFlags:[],shadowBanned:!1,createdAt:new Date().toISOString()};return await this.collection.insertOne(r),r}async findByFingerprint(e){return this.collection.findOne({fingerprint:e})}async update(e){await this.collection.updateOne({fingerprint:e.fingerprint},{$set:e})}async incrementReportCount(e){await this.collection.updateOne({fingerprint:e},{$inc:{reportCount:1},$set:{lastReportTime:new Date().toISOString()}})}async adjustTrustScore(e,t){let r=await this.findByFingerprint(e);if(!r)return;let n=Math.max(0,Math.min(100,r.trustScore+t));await this.collection.updateOne({fingerprint:e},{$set:{trustScore:n}})}async addAbuseFlag(e,t){await this.collection.updateOne({fingerprint:e},{$addToSet:{abuseFlags:t}})}async setShadowBanned(e,t){await this.collection.updateOne({fingerprint:e},{$set:{shadowBanned:t}})}async findAll(e=100){return this.collection.find({}).sort({trustScore:-1}).limit(e).toArray()}}},8484:(e,t,r)=>{r.d(t,{N:()=>s});let n=require("mongodb"),i=process.env.MONGODB_URI,a={},o=null;async function s(){return(await function(){if(!process.env.MONGODB_URI)throw Error("Please add your Mongo URI to .env.local");return o||(o=new n.MongoClient(i,a).connect())}()).db()}},5634:(e,t,r)=>{var n,i;r.d(t,{R:()=>n}),function(e){e.QUEUED="QUEUED",e.PROCESSING="PROCESSING",e.WEIGHTED="WEIGHTED"}(n||(n={})),function(e){e.TRADE_SCAM="TRADE_SCAM",e.FAKE_MIDDLEMAN="FAKE_MIDDLEMAN",e.ACCOUNT_SCAM="ACCOUNT_SCAM",e.COIN_SCAM="COIN_SCAM",e.OTHER="OTHER"}(i||(i={}))}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[276,972,585],()=>r(5545));module.exports=n})();